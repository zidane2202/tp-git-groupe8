name: ü§ñ Code Review and Notification

on:
  push:
    branches:
      - develop  # change en main si n√©cessaire

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repository
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    # 2Ô∏è‚É£ Set up Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    # 3Ô∏è‚É£ Install dependencies
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install google-genai

    # 4Ô∏è‚É£ Debug: lister les fichiers pour v√©rifier le chemin
    - name: List files for debugging
      run: ls -R

    # 5Ô∏è‚É£ Get committer email & changed files, puis run le script
    - name: Run Code Review Script
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
      run: |
        # Email du dernier commit
        COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
        
        # Fichiers modifi√©s dans le dernier commit
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
        
        echo "Commit author: $COMMIT_AUTHOR_EMAIL"
        echo "Changed files: $CHANGED_FILES"

        # Ex√©cution du script Python
        python scripts/review_mailer.py "$COMMIT_AUTHOR_EMAIL" "$CHANGED_FILES"
