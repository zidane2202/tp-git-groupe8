#!/bin/bash
#
# Hook pre-push : v√©rifie linters + IA avant d'autoriser le push
#

echo "üîç Lancement des v√©rifications : linters..."

# 1) Linters
npx eslint . --ext .js
eslint_status=$?

npx htmlhint "**/*.html"
html_status=$?

npx stylelint "**/*.css"
css_status=$?

if [ $eslint_status -ne 0 ] || [ $html_status -ne 0 ] || [ $css_status -ne 0 ]; then
  echo "‚ùå Erreurs d√©tect√©es par les linters. Push annul√©."
  # On g√©n√®re un rapport simple et on envoie mail (ici on signale juste "linters")
  echo "Erreurs linters d√©tect√©es" > ai_report.txt
  node sendMail.js fail
  exit 1
fi

# 2) Analyse IA : on envoie le diff mis en cache au script Node
echo "ü§ñ Ex√©cution de l'analyse IA..."
# R√©cup√®re le diff des changements mis en stage (cached)
git diff --cached --unified=0 | node analyseAI.js
ai_status=$?

if [ $ai_status -ne 0 ]; then
  echo "‚ùå L'IA a trouv√© des probl√®mes. Push annul√©."
  node sendMail.js fail
  exit 1
fi

# 3) Tout OK
echo "‚úÖ Linters et IA OK. Push autoris√©."
node sendMail.js success
exit 0
