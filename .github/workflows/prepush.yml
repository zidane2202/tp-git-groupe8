name: ü§ñ Code Review and Notification

on:
  push:
    branches:
      - develop  # <-- tu peux changer en main si n√©cessaire

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ R√©cup√©ration du code
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # pour comparer le commit pr√©c√©dent

    # 2Ô∏è‚É£ Installation de Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    # 3Ô∏è‚É£ Installation des d√©pendances
    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    # 4Ô∏è‚É£ D√©tection de l‚Äôauteur du commit et des fichiers modifi√©s
    - name: üîç Get committer email and changed files
      id: changes
      run: |
        COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
        echo "COMMIT_AUTHOR_EMAIL=$COMMIT_AUTHOR_EMAIL" >> $GITHUB_ENV
        echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV

    # 5Ô∏è‚É£ Revue IA et envoi de mail
    - name: ü§ñ Run AI Review and Send Email
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        RECIPIENT_EMAIL: ${{ env.COMMIT_AUTHOR_EMAIL }}
        CHANGED_FILES: ${{ env.CHANGED_FILES }}
      run: |
        python scripts/review_mailer.py "$RECIPIENT_EMAIL" "$CHANGED_FILES"
