name: AI Code Review & Mailer

on: [push]  # Se déclenche à chaque push

jobs:
  ai-review:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout du code
        uses: actions/checkout@v4

      - name: 🐍 Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: 📦 Installer la bibliothèque Gemini
        run: pip install google-genai

      - name: 🔍 Récupérer la liste des fichiers modifiés
        id: changes
        run: |
          git fetch origin main || true
          git diff --name-only HEAD~1 HEAD > changed_files.txt
          echo "changed_files=$(cat changed_files.txt | tr '\n' ' ')" >> $GITHUB_ENV

      - name: 🤖 Analyse IA et envoi de mail
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
        run: |
          python scripts/review_mailer.py \
            "ton.email@exemple.com" \
            "${{ env.changed_files }}"
