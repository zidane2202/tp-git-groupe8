#!/bin/bash

# Am√©lioration du hook pre-push : recherche un interpr√©teur Python cross-plateforme

SCRIPT_PATH="scripts/review_mailer.py"

# Email de l'auteur du commit
RECIPIENT_EMAIL=$(git log -1 --pretty=format:'%ae')

# Tous les fichiers staged pour le push
CHANGED_FILES=$(git diff --cached --name-only | paste -sd "," -)

# Trouver un ex√©cutable Python
if command -v python3 >/dev/null 2>&1; then
  PY_EXEC="python3"
elif command -v python >/dev/null 2>&1; then
  PY_EXEC="python"
else
  # Essayer le lanceur Windows 'py -3'
  if py -3 -V >/dev/null 2>&1; then
    PY_EXEC="py -3"
  else
    echo "Python introuvable. Installez Python ou ajustez le hook pour utiliser le bon ex√©cutable." >&2
    exit 1
  fi
fi

# Ex√©cuter le script (g√©rer le cas o√π PY_EXEC contient un espace pour 'py -3')
if [ "$PY_EXEC" = "py -3" ]; then
  eval "$PY_EXEC \"$SCRIPT_PATH\" \"$RECIPIENT_EMAIL\" \"$CHANGED_FILES\""
else
  "$PY_EXEC" "$SCRIPT_PATH" "$RECIPIENT_EMAIL" "$CHANGED_FILES"
fi

EXIT_CODE=$?
if [ $EXIT_CODE -ne 0 ]; then
    echo "üö´ Push annul√© : des erreurs de code ont √©t√© d√©tect√©es."
    exit 1
fi

exit 0
