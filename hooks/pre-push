#!/bin/bash

# --- Hook pre-push pour bloquer le push si des erreurs d√©tect√©es ---

# Racine du d√©p√¥t
REPO_ROOT=$(git rev-parse --show-toplevel)

# Chemin complet du script
SCRIPT_PATH="$REPO_ROOT/scripts/review_mailer.py"

# Email de l'auteur du commit
RECIPIENT_EMAIL=$(git log -1 --pretty=format:'%ae')

# Tous les fichiers staged pour le push
CHANGED_FILES=$(git diff --cached --name-only | paste -sd "," -)

# V√©rifier si Python existe
if command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
elif command -v python &> /dev/null; then
    PYTHON_CMD="python"
else
    echo "‚ö†Ô∏è Python non trouv√©. La v√©rification locale est ignor√©e."
    exit 0
fi

# Ex√©cution du script Python
$PYTHON_CMD "$SCRIPT_PATH" "$RECIPIENT_EMAIL" "$CHANGED_FILES"

EXIT_CODE=$?
if [ $EXIT_CODE -ne 0 ]; then
    echo "üö´ Push annul√© : des erreurs de code ont √©t√© d√©tect√©es."
    exit 1
fi

exit 0
